name: Auto Merge

on:
  pull_request_review:
    type: [submitted]
    branches:
      - master
      - development

jobs:
  commit_filter:
    name: Filter Commit
    runs-on: ubuntu-latest
    if: "!contains(github.event.pull_request.title, 'chore: auto sync master with development')"
    steps:
      - name: Echo the greeting
        run: echo 'Auto Merge triggered.'
  auto_merge_pr:
    name: Auto Merge Pull Request
    runs-on: ubuntu-latest
    needs: [commit_filter]
    if: "!contains(github.event.pull_request.title, 'chore: auto sync master with development')"
    steps:
      - name: Wait for CI
        uses: fountainhead/action-wait-for-check@v1.0.0
        id: wait-for-ci
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "Code Checking"
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          timeoutSeconds: 60
      - name: Do something with a passing check
        if: steps.wait-for-ci.outputs.conclusion == 'success'
        run: echo "Check Successful"
      - name: Do something with a failed check
        if: steps.wait-for-ci.outputs.conclusion != 'success'
        run: echo "Check failed" && exit 1
      - if: success()
        name: Auto Merge PR
        uses: "pascalgn/automerge-action@4536e8847eb62fe2f0ee52c8fa92d17aa97f932f"
        env:
          GITHUB_TOKEN: "${{ secrets.CICD_CREDENTIALS }}"
          MERGE_LABELS: ""
          MERGE_METHOD: "squash"
